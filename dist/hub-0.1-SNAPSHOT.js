/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function q(a,b){function c(d){var e=j;j=c.second;o=d;try{c.first(d);j&&c.second(d)}finally{j=e;o=undefined}}c.first=a;c.second=b;return c}function r(a,b){if(a!==b){if(a.first===b)return a.second;if(!(a.second=r(a.second,b)))return a.first;return a}}function p(a,b){for(var c in b){var d=b[c];a[c]=c in a?q(d,a[c]):d}}function l(a){var b={},c=k[a],d=true;if(c){for(var e=c.is?typeof c.is==="string"?[c.is]:c.is:y,g=0,f;f=e[g++];)p(b,h[f]||l(f));p(b,c.factory());if(c.scope===Hub.PROTOTYPE)d=
false}if(d)if(a in h)p(h[a],b);else h[a]=b;return b}function s(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");return RegExp("^"+a+"$")}function t(a,b,c){Hub.publish("hub.error.error","publish",{message:"Error in callback for {namespace}/{message}: {error}",context:{namespace:a,message:b,error:c}})}function u(a,b,c,d){if(b[c])try{return b[c](d)}catch(e){t(a,c,e.message);return}if(c.indexOf("*")!==-1){var g=s(c),f;for(c in b)if(g.test(c))try{f=Hub.util.merge(f,
b[c](d))}catch(m){t(a,c,m.message)}return f}}function v(a,b,c){if(c){if(!a.success)return true;try{a.success(b);return true}catch(d){console.warn("Hub - error in promise success handler: "+d.message);return false}}if(a.error)try{a.error(b)}catch(e){console.warn("Hub - error in promise error handler: "+e.message)}return false}function n(a){var b=[],c,d=true;return{then:function(e,g){var f={success:e,error:g};a?v(f,c,e):b.push(f);return this},publish:function(e,g,f){if(a){f=Hub.util.merge(c,f);return Hub.publish(e,
g,f)}return this.then(function(){f=Hub.util.merge(c,f);return Hub.publish(e,g,f)})},fulfill:function(e){this.mergeValue(e);for(a=true;b.length;)d=v(b.shift(),c,d);return this},fulfilled:function(){return a},mergeValue:function(e){if(a)throw Error("Hub - promise already fulfilled");c=Hub.util.merge(c,e)}}}function w(a){var b=n(true);a.then=b.then;a.publish=b.publish;return b}var h={},k={},j=false,o,i=true,y=[],x=function(){};x.prototype={then:function(a,b){return w(this).then(a,b)},publish:function(a,
b,c){return w(this).publish(a,b,c)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){h={};for(var a in k)a.indexOf("lib.")===-1&&delete k[a]},subscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}a=h[a]||l(a);a[b]=b in a?q(c,a[b]):c},unsubscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,
d)}if(a=h[a])if(a[b]&&!(a[b]=r(a[b],c)))delete a[b]},peer:function(a,b,c){if(k[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;k[a]=b;h[a]&&l(a)},publish:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}d=i;var e;i=false;if(a.indexOf("*")===-1){var g=h[a]||l(a);e=u(a,g,b,c)}else{var f,m=[];g=s(a);for(f in k)g.test(f)&&m.push(h[f]||l(f));for(f=0;g=m[f++];){g=u(a,g,b,c);e=Hub.util.merge(e,g)}}a=i;i=d;if(e!==undefined)if(a)a.mergeValue(e);
else{a=n(false);a.fulfill(e)}return a||new x},stopPropagation:function(){j=false},propagate:function(){j(o);j=false},promise:function(){if(i===true)return n(false);if(i===false)i=n(false);return i},lazy:function(){throw Error("Not yet supported");},forward:function(a,b,c,d,e,g){if(typeof a==="object")for(var f in a){b=a[f];typeof b==="string"?Hub.forward(f,b):Hub.forward.apply(Hub,[f].concat(b))}else{f=a.indexOf("/");if(f!==-1){g=e;e=d;d=c;c=b;b=a.substring(f+1);a=a.substring(0,f)}Hub.subscribe(a,
b,Hub.forwarder(c,d,g,e))}},forwarder:function(a,b,c,d){var e=a.indexOf("/");if(e!==-1){d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}if(c){if(d)return function(g){return Hub.publish(a,b,Hub.util.merge(c(g),d))};if(typeof c==="function")return function(g){return Hub.publish(a,b,c(g))};return function(g){return Hub.publish(a,b,Hub.util.merge(g,c))}}return function(g){return Hub.publish(a,b,g)}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;
var c=Object.prototype.toString.call(b),d=Object.prototype.toString.call(a);if(d===c){if(c==="[object Object]"){for(var e in b)a[e]=arguments.callee(a[e],b[e]);return a}if(c==="[object Array]")return a.concat(b)}Hub.publish("hub.error.warn","util.merge",{message:d===c?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",context:{target:a,source:b,targetType:d,sourceType:c}});return a}}}}();
