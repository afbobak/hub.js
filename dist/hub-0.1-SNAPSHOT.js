/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function y(a,b){function c(d){var f=q;q=c.second;v=d;try{c.first(d);q&&c.second(d)}finally{q=f;v=undefined}}c.first=a;c.second=b;return c}function z(a,b){if(a!==b){if(a.first===b)return a.second;if(!(a.second=z(a.second,b)))return a.first;return a}}function w(a,b){for(var c in b){var d=b[c];a[c]=c in a?y(d,a[c]):d}}function s(a){var b={},c=r[a],d=true;if(c){for(var f=c.is?typeof c.is==="string"?[c.is]:c.is:M,g=0,e;e=f[g++];)w(b,n[e]||s(e));w(b,c.factory());if(c.scope===Hub.PROTOTYPE)d=
false}if(d)if(a in n)w(n[a],b);else n[a]=b;return b}function A(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");return RegExp("^"+a+"$")}function B(a,b,c){Hub.publish("hub.error","publish",{type:"error",description:"Error in callback for {namespace}/{message}: {error}",context:{namespace:a,message:b,error:c}})}function C(a,b){if(a!==undefined){var c=t(true,a);i=i?D(i,c,b):c}}function E(a,b,c,d,f){if(b[c])try{C(b[c](d),f)}catch(g){B(a,c,g.message);return}if(c.indexOf("*")!==
-1){var e=A(c);for(c in b)if(e.test(c))try{C(b[c](d),f)}catch(j){B(a,c,j.message)}}}function F(){k=Number.MAX_VALUE;for(key in o)k=Math.min(k,Number(key));if(k===Number.MAX_VALUE)k=false;else p=setTimeout(G,k-(new Date).getTime())}function G(){p=false;var a=String(k),b=o[a];if(b){for(var c=0,d=b.length;c<d;c++)b[c].reject({type:"timeout"});delete o[a]}F()}function N(a,b){var c=(new Date).getTime()+b,d=String(c);if(d in o)o[d].push(a);else o[d]=[a];if(!k||k>c){p&&clearTimeout(p);p=setTimeout(G,b);
k=c}return d}function H(a,b){if(a){for(var c=o[a],d=c.length;d--;)if(c[d]===b){if(c.length===1)delete o[a];else c.splice(d,1);break}F()}}function x(a,b){if(a)try{a(b)}catch(c){Hub.publish("hub.error","promise.callback",{type:"error",description:"Error in promise callback: ${error}",context:{error:c.message}})}}function I(){Hub.publish("hub.error","promise.fulfilled",{type:"validation",description:"Promise already fulfilled",context:{}})}function t(a,b,c){var d=[],f=[],g=true,e,j;j={then:function(h,
l){if(a)x(g?h:l,b);else{h&&d.push(h);l&&f.push(l)}return this},publish:function(h,l,m,J){if(a){m=Hub.util.merge(b,m);return Hub.publish(h,l,m,J)}return this.then(function(){m=Hub.util.merge(b,m);Hub.publish(h,l,m,J)})},fulfill:function(h){if(a)I();else{a=true;H(e,j);for(b=Hub.util.merge(b,h);d.length;)x(d.shift(),b)}return this},reject:function(h){if(a)I();else{a=true;g=false;for(H(e,j);d.length;)x(f.shift(),h)}return this},fulfilled:function(){return a}};if(!a&&c)e=N(j,c);return j}function D(a,b,
c){function d(){if(++j===2)(l?h.fulfill:h.reject)(e)}function f(m){if(l)e=Hub.util.merge(e,m);d()}function g(m){if(l){l=false;e=m}else e=Hub.util.merge(e,m);d()}var e,j=0,h=t(false,undefined,c),l=true;a.then(f,g);b.then(f,g);return h}function K(a){var b=t(true);a.then=b.then;a.publish=b.publish;return b}var n={},r={},q=false,v,M=[],i=true,o={},u,k=false,p=false,L=function(){};L.prototype={then:function(a,b){return K(this).then(a,b)},publish:function(a,b,c,d){return K(this).publish(a,b,c,d)},fulfill:function(){throw Error("Hub - promise already fulfilled");
},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){n={};for(var a in r)a.indexOf("lib.")===-1&&delete r[a];p&&clearTimeout(p);o={};p=k=false},subscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}a=n[a]||s(a);a[b]=b in a?y(c,a[b]):c},unsubscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}if(a=n[a])if(a[b]&&!(a[b]=z(a[b],c)))delete a[b]},peer:function(a,
b,c){if(r[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;r[a]=b;n[a]&&s(a)},publish:function(a,b,c,d){var f=a.indexOf("/");if(f!==-1){d=c;c=b;b=a.substring(f+1);a=a.substring(0,f)}f=i;i=false;var g=u;u=d;if(a.indexOf("*")===-1){var e=n[a]||s(a);E(a,e,b,c,d)}else{var j=[],h=A(a);for(e in r)h.test(e)&&j.push(n[e]||s(e));for(h=0;e=j[h++];)E(a,e,b,c,d)}u=g;a=i;i=f;return a||new L},stopPropagation:function(){q=false},propagate:function(){q(v);q=false},promise:function(a){a=
t(false,undefined,a||u);if(i===true)return a;if(i===false)return i=a;i=D(i,a);return a},lazy:function(){throw Error("Not yet supported");},forward:function(a,b,c,d,f,g){if(typeof a==="object")for(var e in a){b=a[e];typeof b==="string"?Hub.forward(e,b):Hub.forward.apply(Hub,[e].concat(b))}else{e=a.indexOf("/");if(e!==-1){g=f;f=d;d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}Hub.subscribe(a,b,Hub.forwarder(c,d,g,f))}},forwarder:function(a,b,c,d){var f=a.indexOf("/");if(f!==-1){d=c;c=b;b=a.substring(f+
1);a=a.substring(0,f)}if(c){if(d)return function(g){return Hub.publish(a,b,Hub.util.merge(c(g),d))};if(typeof c==="function")return function(g){return Hub.publish(a,b,c(g))};return function(g){return Hub.publish(a,b,Hub.util.merge(g,c))}}return function(g){return Hub.publish(a,b,g)}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString.call(b),d=Object.prototype.toString.call(a);if(d===c){if(c==="[object Object]"){for(var f in b)a[f]=
arguments.callee(a[f],b[f]);return a}if(c==="[object Array]")return a.concat(b)}Hub.publish("hub.error","util.merge",{type:"validation",description:d===c?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",context:{target:a,source:b,targetType:d,sourceType:c}});return a}}}}();
