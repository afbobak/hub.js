/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function x(a,b){function c(d){var e=p;p=c.second;u=d;try{c.first(d);p&&c.second(d)}finally{p=e;u=undefined}}c.first=a;c.second=b;return c}function y(a,b){if(a!==b){if(a.first===b)return a.second;if(!(a.second=y(a.second,b)))return a.first;return a}}function v(a,b){for(var c in b){var d=b[c];a[c]=c in a?x(d,a[c]):d}}function s(a){var b={},c=r[a],d=true;if(c){for(var e=c.is?typeof c.is==="string"?[c.is]:c.is:J,f=0,g;g=e[f++];)v(b,l[g]||s(g));v(b,c.factory());if(c.scope===Hub.PROTOTYPE)d=
false}if(d)if(a in l)v(l[a],b);else l[a]=b;return b}function z(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");return RegExp("^"+a+"$")}function A(a,b,c){Hub.publish("hub.error.error","publish",{message:"Error in callback for {namespace}/{message}: {error}",context:{namespace:a,message:b,error:c}})}function B(a,b){if(a!==undefined){var c=t(true,a);j=j?C(j,c,b):c}}function D(a,b,c,d,e){if(b[c])try{B(b[c](d),e)}catch(f){A(a,c,f.message);return}if(c.indexOf("*")!==
-1){var g=z(c);for(c in b)if(g.test(c))try{B(b[c](d),e)}catch(h){A(a,c,h.message)}}}function w(a,b,c){if(c){if(!a.success)return true;try{a.success(b);return true}catch(d){console.warn("Hub - error in promise success handler: "+d.message);return false}}if(a.error)try{a.error(b)}catch(e){console.warn("Hub - error in promise error handler: "+e.message)}return false}function E(){k=Number.MAX_VALUE;for(key in m)k=Math.min(k,Number(key));if(k===Number.MAX_VALUE)k=false;else n=setTimeout(F,k-(new Date).getTime())}
function F(){n=false;var a=String(k),b=m[a];if(b){for(var c=0,d=b.length;c<d;c++)b[c].reject({type:"timeout"});delete m[a]}E()}function K(a,b){var c=(new Date).getTime()+b,d=String(c);if(d in m)m[d].push(a);else m[d]=[a];if(!k||k>c){n&&clearTimeout(n);n=setTimeout(F,b);k=c}return d}function G(a,b){for(var c=m[a],d=c.length;d--;)if(c[d]===b){if(c.length===1)delete m[a];else c.splice(d,1);break}E()}function t(a,b,c){var d=[],e=true,f,g;g={then:function(h,o){var i={success:h,error:o};a?w(i,b,h):d.push(i);
return this},publish:function(h,o,i,q){if(a){i=Hub.util.merge(b,i);return Hub.publish(h,o,i,q)}return this.then(function(){i=Hub.util.merge(b,i);Hub.publish(h,o,i,q)})},fulfill:function(h){if(a)throw Error("Hub - promise already fulfilled");a=true;G(f,g);for(b=Hub.util.merge(b,h);d.length;)e=w(d.shift(),b,e);return this},reject:function(h){if(a)throw Error("Hub - promise already fulfilled");a=true;G(f,g);for(e=false;d.length;)e=w(d.shift(),h,e);return this},fulfilled:function(){return a}};a||(f=K(g,
c||2E4));return g}function C(a,b,c){function d(){if(++h===2)(i?o.fulfill:o.reject)(g)}function e(q){if(i)g=Hub.util.merge(g,q);d()}function f(q){if(i){i=false;g=q}else g=Hub.util.merge(g,q);d()}var g,h=0,o=t(false,undefined,c),i=true;a.then(e,f);b.then(e,f);return o}function H(a){var b=t(true);a.then=b.then;a.publish=b.publish;return b}var l={},r={},p=false,u,j=true,J=[],m={},k=false,n=false,I=function(){};I.prototype={then:function(a,b){return H(this).then(a,b)},publish:function(a,b,c,d){return H(this).publish(a,
b,c,d)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){l={};for(var a in r)a.indexOf("lib.")===-1&&delete r[a];n&&clearTimeout(n);m={};n=k=false},subscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}a=l[a]||s(a);a[b]=b in a?x(c,a[b]):c},unsubscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,
d)}if(a=l[a])if(a[b]&&!(a[b]=y(a[b],c)))delete a[b]},peer:function(a,b,c){if(r[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;r[a]=b;l[a]&&s(a)},publish:function(a,b,c,d){var e=a.indexOf("/");if(e!==-1){d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}e=j;j=false;if(a.indexOf("*")===-1){var f=l[a]||s(a);D(a,f,b,c,d)}else{var g=[],h=z(a);for(f in r)h.test(f)&&g.push(l[f]||s(f));for(h=0;f=g[h++];)D(a,f,b,c,d)}a=j;j=e;return a||new I},stopPropagation:function(){p=
false},propagate:function(){p(u);p=false},promise:function(a){a=t(false,undefined,a);if(j===true)return a;if(j===false)return j=a;j=C(j,a);return a},lazy:function(){throw Error("Not yet supported");},forward:function(a,b,c,d,e,f){if(typeof a==="object")for(var g in a){b=a[g];typeof b==="string"?Hub.forward(g,b):Hub.forward.apply(Hub,[g].concat(b))}else{g=a.indexOf("/");if(g!==-1){f=e;e=d;d=c;c=b;b=a.substring(g+1);a=a.substring(0,g)}Hub.subscribe(a,b,Hub.forwarder(c,d,f,e))}},forwarder:function(a,
b,c,d){var e=a.indexOf("/");if(e!==-1){d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}if(c){if(d)return function(f){return Hub.publish(a,b,Hub.util.merge(c(f),d))};if(typeof c==="function")return function(f){return Hub.publish(a,b,c(f))};return function(f){return Hub.publish(a,b,Hub.util.merge(f,c))}}return function(f){return Hub.publish(a,b,f)}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString.call(b),d=Object.prototype.toString.call(a);
if(d===c){if(c==="[object Object]"){for(var e in b)a[e]=arguments.callee(a[e],b[e]);return a}if(c==="[object Array]")return a.concat(b)}Hub.publish("hub.error.warn","util.merge",{message:d===c?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",context:{target:a,source:b,targetType:d,sourceType:c}});return a}}}}();
