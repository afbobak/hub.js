/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function u(a,b){var c=function(d){if(a)if(b){var e=l;l=b;w=d;try{a(d);l&&b(d)}finally{l=e;w=undefined}}else a(d);else b(d)};c.remove=function(d){if(d===a){a=undefined;return b}if(d===b||typeof b.remove==="function"&&!(b=b.remove(d))){b=undefined;return a}return c};return c}function x(a,b){for(var c in b){var d=b[c];a[c]=c in a?u(d,a[c]):d}}function s(a){var b={},c=p[a],d=true;if(c){for(var e=c.is?typeof c.is==="string"?[c.is]:c.is:I,f=0,g;g=e[f++];)x(b,k[g]||s(g));x(b,c.factory());
if(c.scope===Hub.PROTOTYPE)d=false}if(d)if(a in k)x(k[a],b);else k[a]=b;return b}function z(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");return RegExp("^"+a+"$")}function A(a,b,c){Hub.publish("hub.error","publish",{type:"error",description:"Error in callback for {namespace}/{message}: {error}",context:{namespace:a,message:b,error:c}})}function B(a){if(a!==undefined){a=v(true,a);i=i?C(i,a):a}}function D(a,b,c,d){if(b[c])try{B(b[c](d))}catch(e){A(a,c,
e.message);return}if(c.indexOf("*")!==-1){var f=z(c);for(c in b)if(f.test(c))try{B(b[c](d))}catch(g){A(a,c,g.message)}}}function E(){q=undefined;m=(new Date).getTime();var a=-1,b;for(b in n){var c=n[b],d=c[0];if(d<=m){c[1].reject({type:"timeout"});delete n[b]}else a=a===-1?d:Math.min(d,a)}if(a!==-1)t=setTimeout(E,a);m=undefined}function J(a,b){m||(m=(new Date).getTime());var c=++K;n[c]=[m+b,a];if(!q){clearTimeout(t);q=setTimeout(E,15)}return c}function y(a,b){if(a)try{a(b)}catch(c){Hub.publish("hub.error",
"promise.callback",{type:"error",description:"Error in promise callback: ${error}",context:{error:c.message}})}}function F(){Hub.publish("hub.error","promise.fulfilled",{type:"validation",description:"Promise already fulfilled",context:{}})}function v(a,b,c){var d=[],e=[],f=true,g,o;o={then:function(h,j){if(a)y(f?h:j,b);else{h&&d.push(h);j&&e.push(j)}return this},publish:function(h,j,r){if(a){r=Hub.util.merge(b,r);return Hub.publish(h,j,r)}return this.then(function(){r=Hub.util.merge(b,r);Hub.publish(h,
j,r)})},fulfill:function(h){if(a)F();else{a=true;delete n[g];for(b=Hub.util.merge(b,h);d.length;)y(d.shift(),b)}return this},reject:function(h){if(a)F();else{a=true;f=false;for(delete n[g];d.length;)y(e.shift(),h)}return this},fulfilled:function(){return a}};a||(g=J(o,c||6E4));return o}function C(a,b){function c(){if(++g===2)(h?o.fulfill:o.reject)(f)}function d(j){if(h)f=Hub.util.merge(f,j);c()}function e(j){if(h){h=false;f=j}else f=Hub.util.merge(f,j);c()}var f,g=0,o=v(false,undefined),h=true;a.then(d,
e);b.then(d,e);return o}function G(a){var b=v(true);a.then=b.then;a.publish=b.publish;return b}var k={},p={},l=false,w,I=[],i=true,n={},t=undefined,q=undefined,K=0,m=undefined,H=function(){};H.prototype={then:function(a,b){return G(this).then(a,b)},publish:function(a,b,c){return G(this).publish(a,b,c)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){k={};for(var a in p)a.indexOf("lib.")===
-1&&delete p[a];if(q){clearTimeout(q);q=undefined}if(t){clearTimeout(t);t=undefined}m=undefined;n={}},subscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}a=k[a]||s(a);a[b]=b in a?u(c,a[b]):c},unsubscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}if(a=k[a])if(d=a[b])if(d===c)delete a[b];else a[b]=d.remove(c)},peer:function(a,b,c){if(p[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=
b;b={}}b.factory=c;p[a]=b;k[a]&&s(a)},publish:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}d=i;i=false;if(a.indexOf("*")===-1){var e=k[a]||s(a);D(a,e,b,c)}else{var f=[],g=z(a);for(e in p)g.test(e)&&f.push(k[e]||s(e));for(g=0;e=f[g++];)D(a,e,b,c)}a=i;i=d;return a||new H},stopPropagation:function(){l=false},propagate:function(){l(w);l=false},promise:function(a){a=v(false,undefined,a);if(i===true)return a;if(i===false)return i=a;i=C(i,a);return a},lazy:function(){throw Error("Not yet supported");
},forward:function(a,b,c,d,e,f){if(typeof a==="object")for(var g in a){b=a[g];typeof b==="string"?Hub.forward(g,b):Hub.forward.apply(Hub,[g].concat(b))}else{g=a.indexOf("/");if(g!==-1){f=e;e=d;d=c;c=b;b=a.substring(g+1);a=a.substring(0,g)}Hub.subscribe(a,b,Hub.forwarder(c,d,f,e))}},forwarder:function(a,b,c,d){var e=a.indexOf("/");if(e!==-1){d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}if(c){if(d)return function(f){return Hub.publish(a,b,Hub.util.merge(c(f),d))};if(typeof c==="function")return function(f){return Hub.publish(a,
b,c(f))};return function(f){return Hub.publish(a,b,Hub.util.merge(f,c))}}return function(f){return Hub.publish(a,b,f)}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString.call(b),d=Object.prototype.toString.call(a);if(d===c){if(c==="[object Object]"){for(var e in b)a[e]=arguments.callee(a[e],b[e]);return a}if(c==="[object Array]")return a.concat(b)}Hub.publish("hub.error","util.merge",{type:"validation",description:d===
c?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",context:{target:a,source:b,targetType:d,sourceType:c}});return a},chain:function(){var a=arguments.length-1,b=u(arguments[a-1],arguments[a]);for(a--;a;)b=u(arguments[--a],b);return b}}}}();
