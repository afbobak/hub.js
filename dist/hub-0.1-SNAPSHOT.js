/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function t(a,b){var c=function(d){if(a)if(b){var f=q;q=b;w=d;try{a(d);q&&b(d)}finally{q=f;w=undefined}}else a(d);else b(d)};c.remove=function(d){if(d===a){a=undefined;return b}if(d===b||typeof b.remove==="function"&&!(b=b.remove(d))){b=undefined;return a}return c};return c}function x(a,b){for(var c in b){var d=b[c];a[c]=c in a?t(d,a[c]):d}}function s(a){var b={},c=r[a],d=true;if(c){for(var f=c.is?typeof c.is==="string"?[c.is]:c.is:L,g=0,e;e=f[g++];)x(b,n[e]||s(e));x(b,c.factory());
if(c.scope===Hub.PROTOTYPE)d=false}if(d)if(a in n)x(n[a],b);else n[a]=b;return b}function z(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");return RegExp("^"+a+"$")}function A(a,b,c){Hub.publish("hub.error","publish",{type:"error",description:"Error in callback for {namespace}/{message}: {error}",context:{namespace:a,message:b,error:c}})}function B(a,b){if(a!==undefined){var c=u(true,a);i=i?C(i,c,b):c}}function D(a,b,c,d,f){if(b[c])try{B(b[c](d),f)}catch(g){A(a,
c,g.message);return}if(c.indexOf("*")!==-1){var e=z(c);for(c in b)if(e.test(c))try{B(b[c](d),f)}catch(j){A(a,c,j.message)}}}function E(){k=Number.MAX_VALUE;for(key in o)k=Math.min(k,Number(key));if(k===Number.MAX_VALUE)k=false;else p=setTimeout(F,k-(new Date).getTime())}function F(){p=false;var a=String(k),b=o[a];if(b){for(var c=0,d=b.length;c<d;c++)b[c].reject({type:"timeout"});delete o[a]}E()}function M(a,b){var c=(new Date).getTime()+b,d=String(c);if(d in o)o[d].push(a);else o[d]=[a];if(!k||k>
c){p&&clearTimeout(p);p=setTimeout(F,b);k=c}return d}function G(a,b){if(a){for(var c=o[a],d=c.length;d--;)if(c[d]===b){if(c.length===1)delete o[a];else c.splice(d,1);break}E()}}function y(a,b){if(a)try{a(b)}catch(c){Hub.publish("hub.error","promise.callback",{type:"error",description:"Error in promise callback: ${error}",context:{error:c.message}})}}function H(){Hub.publish("hub.error","promise.fulfilled",{type:"validation",description:"Promise already fulfilled",context:{}})}function u(a,b,c){var d=
[],f=[],g=true,e,j;j={then:function(h,l){if(a)y(g?h:l,b);else{h&&d.push(h);l&&f.push(l)}return this},publish:function(h,l,m,I){if(a){m=Hub.util.merge(b,m);return Hub.publish(h,l,m,I)}return this.then(function(){m=Hub.util.merge(b,m);Hub.publish(h,l,m,I)})},fulfill:function(h){if(a)H();else{a=true;G(e,j);for(b=Hub.util.merge(b,h);d.length;)y(d.shift(),b)}return this},reject:function(h){if(a)H();else{a=true;g=false;for(G(e,j);d.length;)y(f.shift(),h)}return this},fulfilled:function(){return a}};if(!a&&
c)e=M(j,c);return j}function C(a,b,c){function d(){if(++j===2)(l?h.fulfill:h.reject)(e)}function f(m){if(l)e=Hub.util.merge(e,m);d()}function g(m){if(l){l=false;e=m}else e=Hub.util.merge(e,m);d()}var e,j=0,h=u(false,undefined,c),l=true;a.then(f,g);b.then(f,g);return h}function J(a){var b=u(true);a.then=b.then;a.publish=b.publish;return b}var n={},r={},q=false,w,L=[],i=true,o={},v,k=false,p=false,K=function(){};K.prototype={then:function(a,b){return J(this).then(a,b)},publish:function(a,b,c,d){return J(this).publish(a,
b,c,d)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){n={};for(var a in r)a.indexOf("lib.")===-1&&delete r[a];p&&clearTimeout(p);o={};p=k=false},subscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,d)}a=n[a]||s(a);a[b]=b in a?t(c,a[b]):c},unsubscribe:function(a,b,c){var d=a.indexOf("/");if(d!==-1){c=b;b=a.substring(d+1);a=a.substring(0,
d)}if(a=n[a])if(d=a[b])if(d===c)delete a[b];else a[b]=d.remove(c)},peer:function(a,b,c){if(r[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;r[a]=b;n[a]&&s(a)},publish:function(a,b,c,d){var f=a.indexOf("/");if(f!==-1){d=c;c=b;b=a.substring(f+1);a=a.substring(0,f)}f=i;i=false;var g=v;v=d;if(a.indexOf("*")===-1){var e=n[a]||s(a);D(a,e,b,c,d)}else{var j=[],h=z(a);for(e in r)h.test(e)&&j.push(n[e]||s(e));for(h=0;e=j[h++];)D(a,e,b,c,d)}v=g;a=i;i=f;return a||
new K},stopPropagation:function(){q=false},propagate:function(){q(w);q=false},promise:function(a){a=u(false,undefined,a||v);if(i===true)return a;if(i===false)return i=a;i=C(i,a);return a},lazy:function(){throw Error("Not yet supported");},forward:function(a,b,c,d,f,g){if(typeof a==="object")for(var e in a){b=a[e];typeof b==="string"?Hub.forward(e,b):Hub.forward.apply(Hub,[e].concat(b))}else{e=a.indexOf("/");if(e!==-1){g=f;f=d;d=c;c=b;b=a.substring(e+1);a=a.substring(0,e)}Hub.subscribe(a,b,Hub.forwarder(c,
d,g,f))}},forwarder:function(a,b,c,d){var f=a.indexOf("/");if(f!==-1){d=c;c=b;b=a.substring(f+1);a=a.substring(0,f)}if(c){if(d)return function(g){return Hub.publish(a,b,Hub.util.merge(c(g),d))};if(typeof c==="function")return function(g){return Hub.publish(a,b,c(g))};return function(g){return Hub.publish(a,b,Hub.util.merge(g,c))}}return function(g){return Hub.publish(a,b,g)}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString.call(b),
d=Object.prototype.toString.call(a);if(d===c){if(c==="[object Object]"){for(var f in b)a[f]=arguments.callee(a[f],b[f]);return a}if(c==="[object Array]")return a.concat(b)}Hub.publish("hub.error","util.merge",{type:"validation",description:d===c?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",context:{target:a,source:b,targetType:d,sourceType:c}});return a},chain:function(){var a=arguments.length-1,b=t(arguments[a-1],arguments[a]);for(a--;a;)b=t(arguments[--a],
b);return b}}}}();
